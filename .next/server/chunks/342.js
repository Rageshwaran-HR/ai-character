"use strict";exports.id=342,exports.ids=[342],exports.modules={32342:(e,t,n)=>{n.r(t),n.d(t,{ChatOpenAI:()=>_,PromptLayerChatOpenAI:()=>b});var a=n(22707),r=n(2443),i=n(47462);function o(e){let t=(0,i.Y_)(e.schema);return{type:"function",function:{name:e.name,description:e.description,parameters:t}}}var s=n(50434),l=n(71734),u=n(75998),p=n(73653),c=n(96010);class m extends p.qV{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[t,n]=super._separateRunnableConfigFromCallOptions(e);return n?.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[t,n]}async invoke(e,t){let n=m._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async *_streamResponseChunks(e,t,n){throw Error("Not implemented.")}async *_streamIterator(e,t){if(this._streamResponseChunks===m.prototype._streamResponseChunks)yield this.invoke(e,t);else{let n;let a=m._convertInputToPromptValue(e).toChatMessages(),[r,i]=this._separateRunnableConfigFromCallOptions(t),o=await c.Ye.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),s={options:i,invocation_params:this?.invocationParams(i)},l=await o?.handleChatModelStart(this.toJSON(),[a],void 0,void 0,s,void 0,void 0,r.runName);try{for await(let e of this._streamResponseChunks(a,i,l?.[0]))yield e.message,n=n?n.concat(e):e}catch(e){throw await Promise.all((l??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((l??[]).map(e=>e?.handleLLMEnd({generations:[[n]]})))}}async _generateUncached(e,t,n){let a=e.map(e=>e.map(r.E1)),i=await c.Ye.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this?.invocationParams(t)},s=await i?.handleChatModelStart(this.toJSON(),a,void 0,void 0,o,void 0,void 0,n.runName),l=await Promise.allSettled(a.map((e,n)=>this._generate(e,{...t,promptIndex:n},s?.[n]))),u=[],p=[];await Promise.all(l.map(async(e,t)=>{if("fulfilled"!==e.status)return await s?.[t]?.handleLLMError(e.reason),Promise.reject(e.reason);{let n=e.value;return u[t]=n.generations,p[t]=n.llmOutput,s?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}}));let m={generations:u,llmOutput:p.length?this._combineLLMOutput?.(...p):void 0};return Object.defineProperty(m,r.WH,{value:s?{runIds:s?.map(e=>e.runId)}:void 0,configurable:!0}),m}async generate(e,t,n){let a;a=Array.isArray(t)?{stop:t}:t;let i=e.map(e=>e.map(r.E1)),[o,s]=this._separateRunnableConfigFromCallOptions(a);if(o.callbacks=o.callbacks??n,!this.cache)return this._generateUncached(i,s,o);let{cache:l}=this,u=this._getSerializedCacheKeyParametersForCall(s),p=[],c=await Promise.all(i.map(async(e,t)=>{let n=m._convertInputToPromptValue(e).toString(),a=await l.lookup(n,u);return a||p.push(t),a})),h={};if(p.length>0){let e=await this._generateUncached(p.map(e=>i[e]),s,o);await Promise.all(e.generations.map(async(e,t)=>{let n=p[t];c[n]=e;let a=m._convertInputToPromptValue(i[n]).toString();return l.update(a,u,e)})),h=e.llmOutput??{}}return{generations:c,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){let a=e.map(e=>e.toChatMessages());return this.generate(a,t,n)}async call(e,t,n){return(await this.generate([e.map(r.E1)],t,n)).generations[0][0].message}async callPrompt(e,t,n){let a=e.toChatMessages();return this.call(a,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){let a=new r.xk(e),i=await this.call([a],t,n);if("string"!=typeof i.content)throw Error("Cannot use predict when output is not a string.");return i.content}}var h=n(58173);function g(e,t){let n=[];for(let[a,r]of Object.entries(e.properties??{}))r.description&&t<2&&n.push(`// ${r.description}`),e.required?.includes(a)?n.push(`${a}: ${d(r,t)},`):n.push(`${a}?: ${d(r,t)},`);return n.map(e=>" ".repeat(t)+e).join("\n")}function d(e,t){if(void 0!==e.anyOf&&Array.isArray(e.anyOf))return e.anyOf.map(e=>d(e,t)).join(" | ");switch(e.type){case"string":if(e.enum)return e.enum.map(e=>`"${e}"`).join(" | ");return"string";case"number":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"integer":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",g(e,t+2),"}"].join("\n");case"array":if(e.items)return`${d(e.items,t)}[]`;return"any[]";default:return""}}function f(e){let t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!r.J.isInstance(e))throw Error("Invalid generic chat message");return"system"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role;default:throw Error(`Unknown message type: ${t}`)}}function y(e){return e.map(e=>({role:f(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id}))}class _ extends m{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.openAIApiKey??(0,l.lS)("OPENAI_API_KEY"),this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,l.lS)("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,l.lS)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??(0,l.lS)("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,l.lS)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,l.lS)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,l.lS)("OPENAI_ORGANIZATION"),this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}invocationParams(e){var t;return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stop,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:void 0!==(t=e?.tools)&&t.every(e=>Array.isArray(e.lc_namespace))?e?.tools.map(o):e?.tools,tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}async *_streamResponseChunks(e,t,n){let a;let i=y(e),o={...this.invocationParams(t),messages:i,stream:!0};for await(let e of(await this.completionWithRetry(o,t))){let i=e?.choices[0];if(!i)continue;let{delta:o}=i;if(!o)continue;let s=function(e,t){let n;let a=e.role??t,i=e.content??"";return(n=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},"user"===a)?new r.ro({content:i}):"assistant"===a?new r.GC({content:i,additional_kwargs:n}):"system"===a?new r.xq({content:i}):"function"===a?new r.Cr({content:i,additional_kwargs:n,name:e.name}):"tool"===a?new r.Xz({content:i,additional_kwargs:n,tool_call_id:e.tool_call_id}):new r.HD({content:i,role:a})}(o,a);a=o.role??a;let l={prompt:t.promptIndex??0,completion:i.index??0};if("string"!=typeof s.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let u=new r.Ls({message:s,text:s.content,generationInfo:l});yield u,n?.handleLLMNewToken(u.text??"",l,void 0,void 0,void 0,{chunk:u})}if(t.signal?.aborted)throw Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){let a={},i=this.invocationParams(t),o=y(e);if(i.stream){let r=this._streamResponseChunks(e,t,n),i={};for await(let e of r){let t=e.generationInfo?.completion??0;void 0===i[t]?i[t]=e:i[t]=i[t].concat(e)}let o=Object.entries(i).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:s,function_call:l}=this.invocationParams(t),u=await this.getEstimatedTokenCountFromPrompt(e,s,l),p=await this.getNumTokensFromGenerations(o);return a.promptTokens=u,a.completionTokens=p,a.totalTokens=u+p,{generations:o,llmOutput:{estimatedTokenUsage:a}}}{let e=await this.completionWithRetry({...i,stream:!1,messages:o},{signal:t?.signal,...t?.options}),{completion_tokens:n,prompt_tokens:l,total_tokens:u}=e?.usage??{};n&&(a.completionTokens=(a.completionTokens??0)+n),l&&(a.promptTokens=(a.promptTokens??0)+l),u&&(a.totalTokens=(a.totalTokens??0)+u);let p=[];for(let t of e?.choices??[]){var s;let e={text:t.message?.content??"",message:"assistant"===(s=t.message??{role:"assistant"}).role?new r.gY(s.content||"",{function_call:s.function_call,tool_calls:s.tool_calls}):new r.J(s.content||"",s.role??"unknown")};t.finish_reason&&(e.generationInfo={finish_reason:t.finish_reason}),p.push(e)}return{generations:p,llmOutput:{tokenUsage:a}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){let e=function(e){let t=["namespace functions {",""];for(let n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(g(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);a+=await this.getNumTokens(e)+9}return t&&e.find(e=>"system"===e._getType())&&(a-=4),"none"===n?a+=1:"object"==typeof n&&(a+=await this.getNumTokens(n.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async getNumTokensFromMessages(e){let t=0,n=0,a=0;"gpt-3.5-turbo-0301"===this.modelName?(n=4,a=-1):(n=3,a=1);let r=await Promise.all(e.map(async e=>{let r=await this.getNumTokens(e.content),i=await this.getNumTokens(f(e)),o=void 0!==e.name?a+await this.getNumTokens(e.name):0,s=r+n+i+o;return"function"===e._getType()&&(s-=2),e.additional_kwargs?.function_call&&(s+=3),e?.additional_kwargs.function_call?.name&&(s+=await this.getNumTokens(e.additional_kwargs.function_call?.name)),e.additional_kwargs.function_call?.arguments&&(s+=await this.getNumTokens(JSON.stringify(JSON.parse(e.additional_kwargs.function_call?.arguments)))),t+=s,s}));return{totalCount:t+=3,countPerMessage:r}}async completionWithRetry(e,t){let n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){throw(0,h.K)(e)}})}_getClientOptions(e){if(!this.client){let e={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},t=(0,s.O)(e),n={...this.clientConfig,baseURL:t,timeout:this.timeout,maxRetries:0};n.baseURL||delete n.baseURL,this.client=new a.Pp(n)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}class b extends _{constructor(e){super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.promptLayerApiKey=e?.promptLayerApiKey??("undefined"!=typeof process?process.env?.PROMPTLAYER_API_KEY:void 0),this.plTags=e?.plTags??[],this.returnPromptLayerId=e?.returnPromptLayerId??!1}async _generate(e,t,n){let a;let r=Date.now();a=Array.isArray(t)?{stop:t}:t?.timeout&&!t.signal?{...t,signal:AbortSignal.timeout(t.timeout)}:t??{};let i=await super._generate(e,a,n),o=Date.now(),s=e=>{let t;if("human"===e._getType())t={role:"user",content:e.content};else if("ai"===e._getType())t={role:"assistant",content:e.content};else if("function"===e._getType())t={role:"assistant",content:e.content};else if("system"===e._getType())t={role:"system",content:e.content};else if("generic"===e._getType())t={role:e.role,content:e.content};else throw Error(`Got unknown type ${e}`);return t},l=(e,t)=>{let n={...this.invocationParams(),model:this.modelName};if(t?.stop&&Object.keys(n).includes("stop"))throw Error("`stop` found in both the input and default params.");return e.map(e=>s(e))};for(let t=0;t<i.generations.length;t+=1){let n;let s=i.generations[t],p=l(e,a),c=[{content:s.text,role:f(s.message)}],m=await (0,u.r)(this.caller,"langchain.PromptLayerChatOpenAI",{...this._identifyingParams(),messages:p,stream:!1},this.plTags,c,r,o,this.promptLayerApiKey);!0===this.returnPromptLayerId&&(!0===m.success&&(n=m.request_id),s.generationInfo&&"object"==typeof s.generationInfo||(s.generationInfo={}),s.generationInfo.promptLayerRequestId=n)}return i}}},75998:(e,t,n)=>{n.d(t,{r:()=>a});let a=async(e,t,n,a,r,i,o,s)=>(await e.call(fetch,"https://api.promptlayer.com/track-request",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({function_name:t,provider:"langchain",kwargs:n,tags:a,request_response:r,request_start_time:Math.floor(i/1e3),request_end_time:Math.floor(o/1e3),api_key:s})})).json()},78303:(e,t,n)=>{},40217:(e,t,n)=>{n(78303)},47462:(e,t,n)=>{n.d(t,{Y_:()=>a.Y_});var a=n(47462);n(78303),n(75459),n(82671),n(97685),n(44093),n(89032),n(23998),n(95753),n(38563),n(6537),n(85316),n(38444),n(78442),n(67046),n(2406),n(16555),n(32192),n(32116),n(66660),n(21917),n(40217),n(22298)},75459:(e,t,n)=>{n(82671),n(97685),n(44093),n(89032),n(23998),n(95753),n(38563),n(6537),n(85316),n(38444),n(78442),n(67046),n(16555),n(32192),n(32116),n(66660),n(21917),n(2406);let a=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")}},82671:(e,t,n)=>{n(75459)},97685:(e,t,n)=>{n(75459)},44093:(e,t,n)=>{n(75459)},89032:(e,t,n)=>{n(75459)},23998:(e,t,n)=>{n(75459)},95753:(e,t,n)=>{n(75459)},38563:(e,t,n)=>{n(75459),n(16555)},6537:(e,t,n)=>{n(75459),n(21917)},85316:(e,t,n)=>{n(75459)},38444:(e,t,n)=>{n(75459)},78442:(e,t,n)=>{n(75459)},67046:(e,t,n)=>{n(75459)},2406:(e,t,n)=>{n(75459)},16555:(e,t,n)=>{n(75459),n(32116)},32192:(e,t,n)=>{n(75459)},32116:(e,t,n)=>{},66660:(e,t,n)=>{n(75459)},21917:(e,t,n)=>{n(75459)},22298:(e,t,n)=>{n(75459),n(40217)}};