"use strict";exports.id=420,exports.ids=[420],exports.modules={66420:(e,t,i)=>{i.r(t),i.d(t,{OpenAI:()=>A,OpenAIChat:()=>m,PromptLayerOpenAI:()=>b,PromptLayerOpenAIChat:()=>c});var r=i(22707),a=i(38547),n=i(2443),s=i(50434),o=i(26005),l=i(71734),p=i(75998),u=i(36338),h=i(58173);class m extends u.S{static lc_name(){return"OpenAIChat"}get callKeys(){return[...super.callKeys,"options","promptIndex"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"prefixMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.openAIApiKey??(0,l.lS)("OPENAI_API_KEY"),this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,l.lS)("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,l.lS)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??((0,l.lS)("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||(0,l.lS)("AZURE_OPENAI_API_DEPLOYMENT_NAME")),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,l.lS)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,l.lS)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,l.lS)("OPENAI_ORGANIZATION"),this.modelName=e?.modelName??this.modelName,this.prefixMessages=e?.prefixMessages??this.prefixMessages,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.maxTokens=e?.maxTokens,this.stop=e?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.n>1)throw Error("Cannot use n > 1 in OpenAIChat LLM. Use ChatOpenAI Chat Model instead.");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}invocationParams(e){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,logit_bias:this.logitBias,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,stop:e?.stop??this.stop,user:this.user,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}formatMessages(e){let t={role:"user",content:e};return this.prefixMessages?[...this.prefixMessages,t]:[t]}async *_streamResponseChunks(e,t,i){let r={...this.invocationParams(t),messages:this.formatMessages(e),stream:!0};for await(let e of(await this.completionWithRetry(r,t))){let r=e?.choices[0];if(!r)continue;let{delta:a}=r,s=new n.b6({text:a.content??""});yield s;let o={prompt:t.promptIndex??0,completion:r.index??0};i?.handleLLMNewToken(s.text??"",o)}if(t.signal?.aborted)throw Error("AbortError")}async _call(e,t,i){let r=this.invocationParams(t);if(r.stream){let r;for await(let a of(await this._streamResponseChunks(e,t,i)))r=void 0===r?a:r.concat(a);return r?.text??""}{let i=await this.completionWithRetry({...r,stream:!1,messages:this.formatMessages(e)},{signal:t.signal,...t.options});return i?.choices[0]?.message?.content??""}}async completionWithRetry(e,t){let i=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,i)}catch(e){throw(0,h.K)(e)}})}_getClientOptions(e){if(!this.client){let e={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},t=(0,s.O)(e),i={...this.clientConfig,baseURL:t,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new r.Pp(i)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}}class c extends m{get lc_secrets(){return{promptLayerApiKey:"PROMPTLAYER_API_KEY"}}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.plTags=e?.plTags??[],this.returnPromptLayerId=e?.returnPromptLayerId??!1,this.promptLayerApiKey=e?.promptLayerApiKey??(0,l.lS)("PROMPTLAYER_API_KEY"),!this.promptLayerApiKey)throw Error("Missing PromptLayer API key")}async _generate(e,t,i){let r;return{generations:await Promise.all(e.map(async e=>{let a=Date.now(),n=await this._call(e,t,i),s=Date.now();r=[{text:n}];let o=await (0,p.r)(this.caller,"langchain.PromptLayerOpenAIChat",{...this._identifyingParams(),prompt:e},this.plTags,{text:n},a,s,this.promptLayerApiKey);return!0===this.returnPromptLayerId&&!0===o.success&&(r[0].generationInfo={promptLayerRequestId:o.request_id}),r}))}}}class A extends u.x{static lc_name(){return"OpenAI"}get callKeys(){return[...super.callKeys,"options"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if((e?.modelName?.startsWith("gpt-3.5-turbo")||e?.modelName?.startsWith("gpt-4"))&&!e?.modelName?.includes("-instruct"))return new m(e,t);if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"bestOf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo-instruct"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.openAIApiKey??(0,l.lS)("OPENAI_API_KEY"),this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,l.lS)("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,l.lS)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??((0,l.lS)("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||(0,l.lS)("AZURE_OPENAI_API_DEPLOYMENT_NAME")),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,l.lS)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,l.lS)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,l.lS)("OPENAI_ORGANIZATION"),this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.batchSize=e?.batchSize??this.batchSize,this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.maxTokens=e?.maxTokens??this.maxTokens,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.bestOf=e?.bestOf??this.bestOf,this.logitBias=e?.logitBias,this.stop=e?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.streaming&&this.bestOf&&this.bestOf>1)throw Error("Cannot stream results when bestOf > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}invocationParams(e){return{model:this.modelName,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,best_of:this.bestOf,logit_bias:this.logitBias,stop:e?.stop??this.stop,user:this.user,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,i){let r=(0,o.F)(e,this.batchSize),n=[],s={},l=this.invocationParams(t);if(-1===l.max_tokens){if(1!==e.length)throw Error("max_tokens set to -1 not supported for multiple inputs");l.max_tokens=await (0,a.F1)({prompt:e[0],modelName:this.modelName})}for(let e=0;e<r.length;e+=1){let a=l.stream?await (async()=>{let a;let n=[];for await(let s of(await this.completionWithRetry({...l,stream:!0,prompt:r[e]},t)))for(let e of(a||(a={id:s.id,object:s.object,created:s.created,model:s.model}),s.choices)){if(n[e.index]){let t=n[e.index];t.text+=e.text,t.finish_reason=e.finish_reason,t.logprobs=e.logprobs}else n[e.index]=e;i?.handleLLMNewToken(e.text,{prompt:Math.floor(e.index/this.n),completion:e.index%this.n})}if(t.signal?.aborted)throw Error("AbortError");return{...a,choices:n}})():await this.completionWithRetry({...l,stream:!1,prompt:r[e]},{signal:t.signal,...t.options});n.push(...a.choices);let{completion_tokens:o,prompt_tokens:p,total_tokens:u}=a.usage?a.usage:{completion_tokens:void 0,prompt_tokens:void 0,total_tokens:void 0};o&&(s.completionTokens=(s.completionTokens??0)+o),p&&(s.promptTokens=(s.promptTokens??0)+p),u&&(s.totalTokens=(s.totalTokens??0)+u)}return{generations:(0,o.F)(n,this.n).map(e=>e.map(e=>({text:e.text??"",generationInfo:{finishReason:e.finish_reason,logprobs:e.logprobs}}))),llmOutput:{tokenUsage:s}}}async *_streamResponseChunks(e,t,i){let r={...this.invocationParams(t),prompt:e,stream:!0};for await(let e of(await this.completionWithRetry(r,t))){let t=e?.choices[0];if(!t)continue;let r=new n.b6({text:t.text,generationInfo:{finishReason:t.finish_reason}});yield r,i?.handleLLMNewToken(r.text??"")}if(t.signal?.aborted)throw Error("AbortError")}async completionWithRetry(e,t){let i=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.completions.create(e,i)}catch(e){throw(0,h.K)(e)}})}_getClientOptions(e){if(!this.client){let e={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},t=(0,s.O)(e),i={...this.clientConfig,baseURL:t,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new r.Pp(i)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}}class b extends A{get lc_secrets(){return{promptLayerApiKey:"PROMPTLAYER_API_KEY"}}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.plTags=e?.plTags??[],this.promptLayerApiKey=e?.promptLayerApiKey??(0,l.lS)("PROMPTLAYER_API_KEY"),this.returnPromptLayerId=e?.returnPromptLayerId,!this.promptLayerApiKey)throw Error("Missing PromptLayer API key")}async _generate(e,t,i){let r=Date.now(),a=await super._generate(e,t,i);for(let t=0;t<a.generations.length;t+=1){let i;let n=Date.now(),s={text:a.generations[t][0].text,llm_output:a.llmOutput},o=await (0,p.r)(this.caller,"langchain.PromptLayerOpenAI",{...this._identifyingParams(),prompt:e[t]},this.plTags,s,r,n,this.promptLayerApiKey);!0===this.returnPromptLayerId&&(o&&!0===o.success&&(i=o.request_id),a.generations[t][0].generationInfo={...a.generations[t][0].generationInfo,promptLayerRequestId:i})}return a}}},75998:(e,t,i)=>{i.d(t,{r:()=>r});let r=async(e,t,i,r,a,n,s,o)=>(await e.call(fetch,"https://api.promptlayer.com/track-request",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({function_name:t,provider:"langchain",kwargs:i,tags:r,request_response:a,request_start_time:Math.floor(n/1e3),request_end_time:Math.floor(s/1e3),api_key:o})})).json()}};